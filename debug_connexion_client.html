<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Connexion Client - MyBankManager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #218838;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-section {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Connexion Client</h1>
    
    <div class="debug-panel">
        <h2>√âtat de l'Authentification</h2>
        <div id="auth-status" class="status disconnected">
            Chargement...
        </div>
        
        <h3>Actions</h3>
        <button class="btn" onclick="checkAuthStatus()">V√©rifier l'√©tat</button>
        <button class="btn" onclick="forceUpdateUI()">Forcer mise √† jour UI</button>
        <button class="btn" onclick="clearSession()">Effacer session</button>
        <button class="btn success" onclick="testClientLogin()">Test Connexion Client</button>
    </div>
    
    <div class="debug-panel">
        <h2>Test de Connexion Client</h2>
        <div class="test-section">
            <h3>1. Test de connexion</h3>
            <p>Utilisez ces identifiants pour tester :</p>
            <ul>
                <li><strong>Email:</strong> test@client.com</li>
                <li><strong>Mot de passe:</strong> password123</li>
            </ul>
            <button class="btn" onclick="simulateClientLogin()">Simuler Connexion Client</button>
        </div>
        
        <div class="test-section">
            <h3>2. V√©rification de l'interface</h3>
            <p>Apr√®s connexion, v√©rifiez que :</p>
            <ul>
                <li>Les boutons "Se connecter" et "S'inscrire" ont disparu</li>
                <li>Les boutons "Mon Compte" et "D√©connexion" sont visibles</li>
                <li>L'interface reste coh√©rente sur toutes les pages</li>
            </ul>
        </div>
    </div>
    
    <div class="debug-panel">
        <h2>Informations de Session</h2>
        <pre id="session-info">Chargement...</pre>
    </div>
    
    <div class="debug-panel">
        <h2>Logs</h2>
        <pre id="logs">Logs appara√Ætront ici...</pre>
    </div>

    <script src="auth-unified.js"></script>
    <script>
        // Fonction pour v√©rifier l'√©tat de l'authentification
        function checkAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            const sessionInfo = document.getElementById('session-info');
            
            if (window.unifiedAuthManager) {
                const isLoggedIn = window.unifiedAuthManager.isLoggedIn();
                const currentUser = window.unifiedAuthManager.getCurrentUser();
                
                if (isLoggedIn && currentUser) {
                    statusDiv.className = 'status connected';
                    statusDiv.innerHTML = `
                        ‚úÖ Connect√©<br>
                        Email: ${currentUser.email}<br>
                        Nom: ${currentUser.fullName}<br>
                        R√¥le: ${currentUser.role}
                    `;
                } else {
                    statusDiv.className = 'status disconnected';
                    statusDiv.innerHTML = '‚ùå Non connect√©';
                }
                
                // Afficher les informations de session
                sessionInfo.textContent = JSON.stringify({
                    isAuthenticated: window.unifiedAuthManager.isAuthenticated,
                    isVerified: window.unifiedAuthManager.isVerified,
                    isAdmin: window.unifiedAuthManager.isAdmin,
                    currentUser: currentUser,
                    localStorage: {
                        currentUser: localStorage.getItem('currentUser'),
                        authToken: localStorage.getItem('authToken'),
                        auth_user: localStorage.getItem('auth_user'),
                        auth_token: localStorage.getItem('auth_token')
                    }
                }, null, 2);
                
                addLog('√âtat v√©rifi√©');
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '‚ùå Gestionnaire d\'authentification non disponible';
                addLog('ERREUR: unifiedAuthManager non disponible');
            }
        }
        
        // Fonction pour simuler une connexion client
        function simulateClientLogin() {
            addLog('üîÑ Simulation de connexion client...');
            
            const userData = {
                id: Date.now(),
                email: 'test@client.com',
                fullName: 'Client Test',
                role: 'client',
                verified: true,
                createdAt: new Date().toISOString()
            };
            
            // Sauvegarder en localStorage
            localStorage.setItem('currentUser', JSON.stringify(userData));
            localStorage.setItem('authToken', 'token_' + Date.now());
            
            // Mettre √† jour le gestionnaire
            if (window.unifiedAuthManager) {
                window.unifiedAuthManager.currentUser = userData;
                window.unifiedAuthManager.isAuthenticated = true;
                window.unifiedAuthManager.isVerified = true;
                window.unifiedAuthManager.isAdmin = false;
                
                // Forcer la mise √† jour de l'interface
                window.unifiedAuthManager.forceUpdateUI();
                
                addLog('‚úÖ Connexion client simul√©e avec succ√®s');
                checkAuthStatus();
            } else {
                addLog('‚ùå Impossible de simuler la connexion - gestionnaire non disponible');
            }
        }
        
        // Fonction pour tester la connexion client
        function testClientLogin() {
            addLog('üß™ Test de connexion client...');
            
            // V√©rifier si le serveur est disponible
            fetch('http://localhost:8081/api/test')
                .then(response => response.json())
                .then(data => {
                    addLog('‚úÖ Serveur disponible');
                    addLog('üìù Redirection vers la page de connexion...');
                    window.location.href = 'connexion.html';
                })
                .catch(error => {
                    addLog('‚ùå Serveur non disponible: ' + error.message);
                    addLog('üí° D√©marrez le serveur avec: node simple_server.js');
                });
        }
        
        // Fonction pour effacer la session
        function clearSession() {
            if (window.unifiedAuthManager) {
                window.unifiedAuthManager.clearSession();
                addLog('Session effac√©e');
                checkAuthStatus();
            }
        }
        
        // Fonction pour ajouter des logs
        function addLog(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // V√©rifier l'√©tat au chargement
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Page de d√©bogage charg√©e');
            setTimeout(checkAuthStatus, 1000);
        });
        
        // Intercepter les logs de la console
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG: ' + args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN: ' + args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '));
        };
    </script>
</body>
</html>
