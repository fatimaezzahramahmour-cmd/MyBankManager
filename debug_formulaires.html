<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Formulaires - MyBankManager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.success {
            background: #28a745;
        }
        .btn.success:hover {
            background: #218838;
        }
        .btn.warning {
            background: #ffc107;
            color: #212529;
        }
        .btn.warning:hover {
            background: #e0a800;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-section {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .test-section h3 {
            margin-top: 0;
            color: #495057;
        }
        .page-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .page-links a {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
        }
        .page-links a:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <h1>üîß Debug Formulaires</h1>
    
    <div class="debug-panel">
        <h2>√âtat de l'Authentification</h2>
        <div id="auth-status" class="status disconnected">
            Chargement...
        </div>
        
        <h3>Actions</h3>
        <button class="btn" onclick="checkAuthStatus()">V√©rifier l'√©tat</button>
        <button class="btn" onclick="forceUpdateUI()">Forcer mise √† jour UI</button>
        <button class="btn" onclick="clearSession()">Effacer session</button>
        <button class="btn success" onclick="simulateClientLogin()">Simuler Connexion Client</button>
        <button class="btn warning" onclick="testFormSubmission()">Test Soumission Formulaire</button>
    </div>
    
    <div class="debug-panel">
        <h2>Test des Pages de Formulaires</h2>
        <div class="test-section">
            <h3>Navigation vers les formulaires</h3>
            <p>Cliquez sur les liens ci-dessous pour tester l'interface sur chaque page :</p>
            <div class="page-links">
                <a href="demande-pret.html" target="_blank">Demande de Pr√™t</a>
                <a href="demande-carte.html" target="_blank">Demande de Carte</a>
                <a href="assurances.html" target="_blank">Assurances</a>
                <a href="index.html" target="_blank">Accueil</a>
            </div>
        </div>
        
        <div class="test-section">
            <h3>V√©rification de l'interface</h3>
            <p>Sur chaque page, v√©rifiez que :</p>
            <ul>
                <li>Si connect√© : boutons "Mon Compte" et "D√©connexion"</li>
                <li>Si non connect√© : boutons "Se connecter" et "S'inscrire"</li>
                <li>L'interface reste coh√©rente apr√®s navigation</li>
            </ul>
        </div>
    </div>
    
    <div class="debug-panel">
        <h2>Test de Soumission de Formulaire</h2>
        <div class="test-section">
            <h3>Message de succ√®s</h3>
            <p>Apr√®s soumission d'un formulaire, v√©rifiez que :</p>
            <ul>
                <li>Le message centr√© appara√Æt : "Message envoy√© avec succ√®s. Veuillez attendre une r√©ponse dans les plus brefs d√©lais."</li>
                <li>Le message reste visible pendant 3 secondes</li>
                <li>Redirection automatique vers l'accueil</li>
                <li>La demande appara√Æt dans le dashboard admin</li>
            </ul>
            <button class="btn" onclick="simulateFormSubmission()">Simuler Soumission Formulaire</button>
        </div>
    </div>
    
    <div class="debug-panel">
        <h2>Informations de Session</h2>
        <pre id="session-info">Chargement...</pre>
    </div>
    
    <div class="debug-panel">
        <h2>Logs</h2>
        <pre id="logs">Logs appara√Ætront ici...</pre>
    </div>

    <script src="auth-unified.js"></script>
    <script>
        // Fonction pour v√©rifier l'√©tat de l'authentification
        function checkAuthStatus() {
            const statusDiv = document.getElementById('auth-status');
            const sessionInfo = document.getElementById('session-info');
            
            if (window.unifiedAuthManager) {
                const isLoggedIn = window.unifiedAuthManager.isLoggedIn();
                const currentUser = window.unifiedAuthManager.getCurrentUser();
                
                if (isLoggedIn && currentUser) {
                    statusDiv.className = 'status connected';
                    statusDiv.innerHTML = `
                        ‚úÖ Connect√©<br>
                        Email: ${currentUser.email}<br>
                        Nom: ${currentUser.fullName}<br>
                        R√¥le: ${currentUser.role}
                    `;
                } else {
                    statusDiv.className = 'status disconnected';
                    statusDiv.innerHTML = '‚ùå Non connect√©';
                }
                
                // Afficher les informations de session
                sessionInfo.textContent = JSON.stringify({
                    isAuthenticated: window.unifiedAuthManager.isAuthenticated,
                    isVerified: window.unifiedAuthManager.isVerified,
                    isAdmin: window.unifiedAuthManager.isAdmin,
                    currentUser: currentUser,
                    localStorage: {
                        currentUser: localStorage.getItem('currentUser'),
                        authToken: localStorage.getItem('authToken'),
                        auth_user: localStorage.getItem('auth_user'),
                        auth_token: localStorage.getItem('auth_token')
                    }
                }, null, 2);
                
                addLog('√âtat v√©rifi√©');
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.innerHTML = '‚ùå Gestionnaire d\'authentification non disponible';
                addLog('ERREUR: unifiedAuthManager non disponible');
            }
        }
        
        // Fonction pour simuler une connexion client
        function simulateClientLogin() {
            addLog('üîÑ Simulation de connexion client...');
            
            const userData = {
                id: Date.now(),
                email: 'test@client.com',
                fullName: 'Client Test',
                role: 'client',
                verified: true,
                createdAt: new Date().toISOString()
            };
            
            // Sauvegarder en localStorage
            localStorage.setItem('currentUser', JSON.stringify(userData));
            localStorage.setItem('authToken', 'token_' + Date.now());
            
            // Mettre √† jour le gestionnaire
            if (window.unifiedAuthManager) {
                window.unifiedAuthManager.currentUser = userData;
                window.unifiedAuthManager.isAuthenticated = true;
                window.unifiedAuthManager.isVerified = true;
                window.unifiedAuthManager.isAdmin = false;
                
                // Forcer la mise √† jour de l'interface
                window.unifiedAuthManager.forceUpdateUI();
                
                addLog('‚úÖ Connexion client simul√©e avec succ√®s');
                checkAuthStatus();
            } else {
                addLog('‚ùå Impossible de simuler la connexion - gestionnaire non disponible');
            }
        }
        
        // Fonction pour simuler une soumission de formulaire
        function simulateFormSubmission() {
            addLog('üìù Simulation de soumission de formulaire...');
            
            // Cr√©er un overlay pour simuler le message de succ√®s
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 9999;
            `;

            const messageBox = document.createElement('div');
            messageBox.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 10px;
                text-align: center;
                max-width: 500px;
                margin: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;

            messageBox.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745; margin-bottom: 20px;"></i>
                <h3 style="color: #28a745; margin-bottom: 15px;">Message envoy√© avec succ√®s</h3>
                <p style="font-size: 16px; line-height: 1.5; color: #333;">
                    Veuillez attendre une r√©ponse dans les plus brefs d√©lais.
                </p>
            `;

            overlay.appendChild(messageBox);
            document.body.appendChild(overlay);

            addLog('‚úÖ Message de succ√®s affich√©');

            // Rediriger vers l'accueil apr√®s 3 secondes
            setTimeout(() => {
                addLog('üîÑ Redirection vers l\'accueil...');
                window.location.href = 'index.html';
            }, 3000);
        }
        
        // Fonction pour tester la soumission de formulaire
        function testFormSubmission() {
            addLog('üß™ Test de soumission de formulaire...');
            addLog('üìù Redirection vers demande-pret.html...');
            window.location.href = 'demande-pret.html';
        }
        
        // Fonction pour effacer la session
        function clearSession() {
            if (window.unifiedAuthManager) {
                window.unifiedAuthManager.clearSession();
                addLog('Session effac√©e');
                checkAuthStatus();
            }
        }
        
        // Fonction pour ajouter des logs
        function addLog(message) {
            const logsDiv = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logsDiv.textContent += `[${timestamp}] ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // V√©rifier l'√©tat au chargement
        document.addEventListener('DOMContentLoaded', function() {
            addLog('Page de d√©bogage formulaires charg√©e');
            setTimeout(checkAuthStatus, 1000);
        });
        
        // Intercepter les logs de la console
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG: ' + args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN: ' + args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '));
        };
    </script>
</body>
</html>
